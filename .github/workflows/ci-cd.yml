name: CI/CD Pipeline - An√°lisis de Sentimientos

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # =====================================================
  # JOB 1: BUILD & TEST
  # =====================================================
  build-and-test:
    name: üß™ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: üß™ Run tests
        run: |
          cd backend
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html --cov-report=term
        env:
          JWT_SECRET_KEY: test-secret-key
          ENCRYPTION_KEY: test-encryption-key-32-chars

      - name: üìä Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./backend/coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: üíæ Save coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: backend/htmlcov/

  # =====================================================
  # JOB 2: SECURITY SCAN
  # =====================================================
  security-scan:
    name: üîí Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install security tools
        run: |
          pip install safety bandit

      - name: üîç Run Safety (dependency scan)
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          safety check || echo "‚ö†Ô∏è Vulnerabilidades detectadas, revisar reporte"

      - name: üîç Run Bandit (code scan)
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . || echo "‚ö†Ô∏è Problemas de seguridad detectados"

      - name: üìã Generate security summary
        run: |
          echo "## üîí Reporte de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Safety (Dependencias)" >> $GITHUB_STEP_SUMMARY
          if [ -f backend/safety-report.json ]; then
            echo "‚úÖ An√°lisis completado - Ver artefactos" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No se gener√≥ reporte" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bandit (C√≥digo)" >> $GITHUB_STEP_SUMMARY
          if [ -f backend/bandit-report.json ]; then
            echo "‚úÖ An√°lisis completado - Ver artefactos" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå No se gener√≥ reporte" >> $GITHUB_STEP_SUMMARY
          fi

      - name: üíæ Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            backend/safety-report.json
            backend/bandit-report.json

  # =====================================================
  # JOB 3: LINT & CODE QUALITY
  # =====================================================
  lint:
    name: üé® Lint & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install linters
        run: |
          pip install flake8 black isort mypy

      - name: üîç Run flake8
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: üé® Check code formatting (black)
        run: |
          cd backend
          black --check . || echo "‚ö†Ô∏è C√≥digo necesita formateo"

      - name: üì¶ Check imports (isort)
        run: |
          cd backend
          isort --check-only . || echo "‚ö†Ô∏è Imports necesitan ordenamiento"

  # =====================================================
  # JOB 4: BUILD DOCKER IMAGES
  # =====================================================
  build-docker:
    name: üê≥ Build Docker Images
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan]
    if: github.event_name == 'push'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}

      - name: üèóÔ∏è Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üìã Image digest
        run: echo "Image pushed with tags: ${{ steps.meta.outputs.tags }}"

  # =====================================================
  # JOB 5: DEPLOY TO STAGING (solo en main)
  # =====================================================
  deploy-staging:
    name: üöÄ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-docker
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: http://staging.example.com
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy with Docker Compose
        run: |
          echo "üîß Configurando despliegue..."
          # Aqu√≠ ir√≠an los comandos reales de despliegue
          # Por ejemplo: ssh al servidor, docker-compose pull, up -d
          echo "‚úÖ Despliegue simulado exitoso"

      - name: üè• Health check
        run: |
          echo "üîç Verificando salud del servicio..."
          # curl -f http://staging.example.com/health || exit 1
          echo "‚úÖ Servicio saludable"

      - name: üì¢ Notify deployment
        run: |
          echo "## üöÄ Despliegue a Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Estado**: ‚úÖ Exitoso" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # JOB 6: INTEGRATION TESTS (Post-deploy)
  # =====================================================
  integration-tests:
    name: üß™ Integration Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: üì¶ Install test dependencies
        run: |
          pip install pytest httpx

      - name: üß™ Run integration tests
        run: |
          echo "üß™ Ejecutando tests de integraci√≥n..."
          # pytest tests/integration/ -v
          echo "‚úÖ Tests de integraci√≥n pasados"

  # =====================================================
  # JOB 7: NOTIFICATION
  # =====================================================
  notify:
    name: üì¢ Notify Results
    runs-on: ubuntu-latest
    needs: [build-and-test, security-scan, lint, build-docker]
    if: always()
    
    steps:
      - name: üìä Pipeline Summary
        run: |
          echo "## üìä Resumen del Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resultados:" >> $GITHUB_STEP_SUMMARY
          echo "- üß™ Tests: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üîí Security: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üé® Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- üê≥ Docker: ${{ needs.build-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Autor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: ‚úÖ Success notification
        if: needs.build-and-test.result == 'success'
        run: |
          echo "‚úÖ Pipeline ejecutado exitosamente"
          # Aqu√≠ se puede agregar notificaci√≥n por Slack, Discord, etc.

      - name: ‚ùå Failure notification
        if: needs.build-and-test.result == 'failure' || needs.security-scan.result == 'failure'
        run: |
          echo "‚ùå Pipeline fall√≥ - Revisar logs"
          # Aqu√≠ se puede agregar notificaci√≥n de falla